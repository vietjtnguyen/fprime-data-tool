# F Prime Data Tool

F Prime Data Tool (`fprime-data-tool`) is a command line utility that can be used to read F Prime data in binary form. This includes the output of `ComLogger` objects and the binary received-data logs generated by `fprime-gds`.  It includes different output options that are conducive to data analysis.

## Input Formats

### Concatenated Records

A "record" is an F Prime packet preceded by a header containing the length of the *packet*.  Below is C code defining this structure with a note that it is packed when serialized (no padding).

```c
struct record {
    RecordSize /*uint16_t or uint32_t*/ record_size;
    struct {
        FwPacketDescriptorType /*uint32_t*/ type;
        union {

            // packet_type == 1 (TELEM)
            struct {
                FwChanIdType /*uint32_t*/ channel_id;
                struct {
                    FwTimeBaseStoreType /*uint16_t*/ base;
                    FwTimeContextStoreType /*uint8_t*/ context;
                    uint32_t seconds;
                    uint32_t microseconds;
                } time;
                char* value;
            } telem;

            // packet_type == 2 (LOG)
            struct {
                FwEventIdType /*uint32_t*/ event_id;
                struct {
                    FwTimeBaseStoreType /*uint16_t*/ base;
                    FwTimeContextStoreType /*uint8_t*/ context;
                    uint32_t seconds;
                    uint32_t microseconds;
                } time;
                char* arguments;
            } event;

      } payload;
    } packet;
} record;
```

The "concatenated records" input format is basically records written one after another.  The record size stored in the record header is equal to the size of the underlying F Prime packet.  For example, an event packet with no arguments is 19 bytes (`uint32_t` + `uint32_t` + `uint16_t` + `uint8_t` + `uint32_t` + `uint32_t`).  The record size written will be 19.

This format covers two different logs: the `recv.bin` log generated by [`fprime-gds`](https://github.com/fprime-community/fprime-gds) and the `*.com` logs generated by [`ComLogger`](https://github.com/nasa/fprime/tree/devel/Svc/ComLogger).  **Note though that the `fprime-gds` log uses a `RecordSize` of `uint32_t` while `ComLogger` uses a `RecordSize` of `uint16_t`.  By default `fprime-data-tool` is configured with a `RecordSize` of `uint16_t` to read `ComLogger` logs.  This can be changed by using the `--RecordSize U32` option when reading `recv.bin` logs.

## Output Formats

### vnlog

This is the default output format which is a whitespace delimited tabular format conducive to quick analysis using [vnlog](https://github.com/dkogan/vnlog) tools such as `vnl-filter` and [feedgnuplot](https://github.com/dkogan/feedgnuplot).

For example you can plot a crude timeline of all events:

```sh
fprime-data-tool -d fsw-dictionary.xml --RecordSize U32 recv.bin \
  | vnl-filter -p 'event_time,event_topology_name,event_id' 'event_component!="-"' \
  | feedgnuplot --domain --dataid --autolegend
```

### Tab separated values (TSV)

This is particularly useful for being ingested into [visidata](https://www.visidata.org/).  In fact, the tool will not support a CSV output format directly because you can just use visidata to do the conversion:

```sh
fprime-data-tool -F tsv -d fsw-dictionary.xml --RecordSize U32 recv.bin \
  | visidata - -b -o recv.csv
```

## Cookbook

### Count number of times a particular event occurs in a `ComLogger` log

```sh
fprime-data-tool -d fsw-dictionary.xml myComLoggerLog.com \
  | vnl-filter 'event_topology_name=="imu.SaturationError"' \
  | wc -l
```

### See all `WARNING_HI` events in a `fprime-gds` `recv.bin` log

```sh
fprime-data-tool -d fsw-dictionary.xml --RecordSize U32 recv.bin \
  | vnl-filter -p 'event' 'event_severity=="WARNING_HI"' \
  | vnl-align \
  | less -S
```

### Create CSV of all records in a `fprime-gds` `recv.bin` log

```sh
fprime-data-tool -F tsv -d fsw-dictionary.xml --RecordSize U32 recv.bin \
  | visidata - -b -o recv.csv
```

## Future Work

- Add Python packaging (i.e. `setup.py`)
- Support decoding of telemetry values
- Support decoding of event arguments
- Add JSON printer
- Support `fprime-gds` protocol input format (with `0xDEADBEEF` sync marker)
- Support encoding of command packets
- Support encoding of file packets given a file
- Support encoding of telemetry packets
- Support encoding of event packets
- Support encoding into `fprime-gds` protocol (with `0xDEADBEEF` sync marker)
- Add [Textual](https://textual.textualize.io/) terminal user interface (TUI) front end
